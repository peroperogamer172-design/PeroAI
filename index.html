<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeroAI v10 - Classic Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f172a; color: #f8fafc; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 300px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chat-container { flex: 1; overflow-y: auto; padding: 2rem; scroll-behavior: smooth; }
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .settings-panel { background: #0f172a; border-top: 1px solid #334155; padding: 1.5rem; }
        .admin-badge { background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .msg-user { background: #3b82f6; align-self: flex-end; border-radius: 18px 18px 2px 18px; }
        .msg-ai { background: #334155; align-self: flex-start; border-radius: 18px 18px 18px 2px; }
        .btn-delete { color: #64748b; transition: 0.2s; }
        .btn-delete:hover { color: #ef4444; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="authOverlay" class="fixed inset-0 bg-[#0f172a] z-[100] flex items-center justify-center p-4">
        <div class="bg-[#1e293b] p-8 rounded-3xl w-full max-w-md border border-slate-700 shadow-2xl">
            <h1 class="text-3xl font-bold text-center mb-6">PeroAI v10</h1>
            
            <div id="userAuth">
                <button onclick="signInGoogle()" class="w-full bg-white text-black font-bold py-3 rounded-xl flex items-center justify-center gap-3 mb-4 hover:bg-slate-200 transition">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="20"> Login with Google
                </button>
                <p class="text-center text-xs text-slate-500">Are you an Admin? <span onclick="toggleAuth(true)" class="text-blue-400 cursor-pointer">Login here</span></p>
            </div>

            <div id="adminAuth" class="hidden space-y-4">
                <input type="email" id="admEmail" placeholder="Admin Email" class="w-full bg-[#0f172a] border border-slate-700 p-3 rounded-xl outline-none">
                <input type="password" id="admPass" placeholder="Password" class="w-full bg-[#0f172a] border border-slate-700 p-3 rounded-xl outline-none">
                <button onclick="adminLogin()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl">Admin Access</button>
                <p onclick="toggleAuth(false)" class="text-center text-xs text-blue-400 cursor-pointer">Back to User Login</p>
            </div>
            <p id="authError" class="text-red-400 text-center text-xs mt-4"></p>
        </div>
    </div>

    <nav class="sidebar">
        <div class="p-6">
            <button onclick="newChat()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> New Chat
            </button>
        </div>

        <div id="historyList" class="flex-1 overflow-y-auto px-4 space-y-2">
            </div>

        <div class="settings-panel space-y-4">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Settings</h3>
            <div>
                <label class="text-[10px] text-slate-400">OpenRouter Key</label>
                <input type="password" id="apiKey" class="w-full bg-[#1e293b] border border-slate-700 text-xs p-2 rounded-lg mt-1" placeholder="sk-or-..." onchange="saveConfig()">
            </div>
            <div>
                <label class="text-[10px] text-slate-400">Model ID</label>
                <input type="text" id="modelId" class="w-full bg-[#1e293b] border border-slate-700 text-xs p-2 rounded-lg mt-1" value="google/gemini-2.0-flash-exp:free" onchange="saveConfig()">
            </div>
            <div id="adminLink" class="hidden">
                <button onclick="openAdmin()" class="w-full bg-red-900/30 text-red-400 text-xs font-bold py-2 rounded-lg border border-red-800/50">
                    <i class="fas fa-shield-alt mr-2"></i> Admin Panel
                </button>
            </div>
            <button onclick="logout()" class="w-full text-slate-500 text-xs hover:text-white py-2"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <header class="h-16 border-b border-slate-800 px-8 flex items-center justify-between bg-[#0f172a]/50 backdrop-blur-sm">
            <div class="flex items-center gap-3">
                <div id="uAvatar" class="w-8 h-8 rounded-full bg-slate-700 overflow-hidden border border-slate-600"></div>
                <div>
                    <h2 id="uName" class="text-sm font-bold">PeroAI User</h2>
                    <span id="uRole" class="text-[10px] text-blue-400 uppercase font-bold">Standard User</span>
                </div>
            </div>
            <div class="text-[10px] font-mono text-slate-500" id="statusInfo">SYSTEM READY</div>
        </header>

        <div id="chatBox" class="chat-container flex flex-col gap-6 pb-32">
            </div>

        <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#0f172a] to-transparent">
            <div class="max-w-4xl mx-auto flex gap-3 bg-[#1e293b] p-2 rounded-2xl border border-slate-700 shadow-2xl">
                <textarea id="msgInput" rows="1" class="flex-1 bg-transparent p-3 outline-none text-sm resize-none" placeholder="Ask PeroAI anything..."></textarea>
                <button onclick="handleSend()" class="bg-blue-600 w-12 h-12 rounded-xl hover:bg-blue-500 transition flex items-center justify-center">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>

    <div id="adminModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-6">
        <div class="bg-[#1e293b] w-full max-w-3xl rounded-3xl border border-red-900/30 flex flex-col h-[80vh]">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <h2 class="text-xl font-bold text-red-400"><i class="fas fa-database mr-2"></i> System Logs & Stats</h2>
                <button onclick="document.getElementById('adminModal').classList.add('hidden')" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="logContent" class="flex-1 overflow-y-auto p-6 font-mono text-xs space-y-2">
                </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqG8rYJZ4xVwR5TrOnzdmlD-eqH8J7TTU",
            authDomain: "peroai-c9000.firebaseapp.com",
            projectId: "peroai-c9000",
            storageBucket: "peroai-c9000.firebasestorage.app",
            messagingSenderId: "175925416280",
            appId: "1:175925416280:web:e530c8fde9dbc34191d52d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let user = null;
        let currentChatId = null;

        // --- AUTH LOGIC ---
        function toggleAuth(isAdmin) {
            document.getElementById('userAuth').classList.toggle('hidden', isAdmin);
            document.getElementById('adminAuth').classList.toggle('hidden', !isAdmin);
        }

        auth.onAuthStateChanged(async (u) => {
            if (u) {
                user = u;
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('uName').innerText = u.displayName || u.email;
                if(u.photoURL) document.getElementById('uAvatar').innerHTML = `<img src="${u.photoURL}">`;
                
                // If logged in via email/pass, treat as Admin
                if(u.providerData[0].providerId === 'password') {
                    document.getElementById('adminLink').classList.remove('hidden');
                    document.getElementById('uRole').innerText = "System Admin";
                    document.getElementById('uRole').className = "text-[10px] text-red-500 uppercase font-bold";
                }

                loadHistory();
                loadLocalConfig();
            } else {
                document.getElementById('authOverlay').classList.remove('hidden');
            }
        });

        function signInGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        async function adminLogin() {
            const e = document.getElementById('admEmail').value;
            const p = document.getElementById('admPass').value;
            try { await auth.signInWithEmailAndPassword(e, p); }
            catch(err) { document.getElementById('authError').innerText = err.message; }
        }
        function logout() { auth.signOut(); }

        // --- SETTINGS & LOCAL STORAGE ---
        function saveConfig() {
            localStorage.setItem('p_key', document.getElementById('apiKey').value);
            localStorage.setItem('p_model', document.getElementById('modelId').value);
        }
        function loadLocalConfig() {
            document.getElementById('apiKey').value = localStorage.getItem('p_key') || "";
            document.getElementById('modelId').value = localStorage.getItem('p_model') || "google/gemini-2.0-flash-exp:free";
        }

        // --- CHAT LOGIC ---
        function newChat() {
            currentChatId = null;
            document.getElementById('chatBox').innerHTML = `
                <div class="h-full flex flex-col items-center justify-center opacity-30 mt-20">
                    <i class="fas fa-robot text-6xl mb-4"></i>
                    <p>Start a new session</p>
                </div>`;
        }

        async function handleSend() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelId').value;

            if(!text) return;
            if(!key) { alert("Please enter your API Key in Settings first!"); return; }

            if(!currentChatId) currentChatId = Date.now().toString();
            
            appendMessage('user', text);
            input.value = '';
            document.getElementById('statusInfo').innerText = "AI IS THINKING...";

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: model,
                        messages: [{role: "user", content: text}]
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);

                const aiText = data.choices[0].message.content;
                appendMessage('ai', aiText);
                saveChat(text, aiText);
                document.getElementById('statusInfo').innerText = "SYSTEM READY";
                logEvent('success', `API Call: ${model}`);
            } catch(e) {
                document.getElementById('statusInfo').innerText = "API ERROR";
                alert("Error: " + e.message);
                logEvent('error', e.message);
            }
        }

        function appendMessage(role, text) {
            const box = document.getElementById('chatBox');
            if(box.querySelector('.fa-robot')) box.innerHTML = ''; // Clear welcome screen
            const div = document.createElement('div');
            div.className = `max-w-[80%] p-4 text-sm ${role === 'user' ? 'msg-user' : 'msg-ai'}`;
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- DATA MANAGEMENT ---
        async function saveChat(uMsg, aMsg) {
            const ref = db.collection('users').doc(user.uid).collection('chats').doc(currentChatId);
            const doc = await ref.get();
            if(doc.exists) {
                await ref.update({ msgs: firebase.firestore.FieldValue.arrayUnion({uMsg, aMsg}) });
            } else {
                await ref.set({ id: currentChatId, title: uMsg.slice(0, 30), timestamp: Date.now(), msgs: [{uMsg, aMsg}] });
                loadHistory();
            }
        }

        async function loadHistory() {
            const snap = await db.collection('users').doc(user.uid).collection('chats').orderBy('timestamp', 'desc').get();
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            snap.forEach(doc => {
                const chat = doc.data();
                const div = document.createElement('div');
                div.className = "group flex items-center justify-between p-3 rounded-xl hover:bg-slate-700 cursor-pointer transition";
                div.innerHTML = `
                    <div class="text-xs truncate flex-1" onclick="loadChat('${chat.id}')">${chat.title}</div>
                    <i class="fas fa-trash btn-delete text-xs opacity-0 group-hover:opacity-100" onclick="deleteChat('${chat.id}')"></i>
                `;
                list.appendChild(div);
            });
        }

        async function loadChat(id) {
            currentChatId = id;
            const doc = await db.collection('users').doc(user.uid).collection('chats').doc(id).get();
            const box = document.getElementById('chatBox');
            box.innerHTML = '';
            doc.data().msgs.forEach(m => {
                appendMessage('user', m.uMsg);
                appendMessage('ai', m.aMsg);
            });
        }

        async function deleteChat(id) {
            if(!confirm("Delete this chat?")) return;
            await db.collection('users').doc(user.uid).collection('chats').doc(id).delete();
            if(currentChatId === id) newChat();
            loadHistory();
        }

        // --- ADMIN FEATURES ---
        async function logEvent(type, msg) {
            try { await db.collection('system_logs').add({ type, msg, user: user.email, time: Date.now() }); } catch(e){}
        }

        async function openAdmin() {
            document.getElementById('adminModal').classList.remove('hidden');
            const snap = await db.collection('system_logs').orderBy('time', 'desc').limit(20).get();
            const container = document.getElementById('logContent');
            container.innerHTML = '';
            snap.forEach(doc => {
                const log = doc.data();
                const color = log.type === 'error' ? 'text-red-400' : 'text-green-400';
                container.innerHTML += `<div class="border-b border-slate-800 pb-1"><span class="text-slate-600">[${new Date(log.time).toLocaleTimeString()}]</span> <span class="${color}">[${log.type.toUpperCase()}]</span> ${log.msg}</div>`;
            });
        }
    </script>
</body>
                </html>
