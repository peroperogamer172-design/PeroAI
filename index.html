<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeroAI v10.2 - Dual Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f172a; color: #f8fafc; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 300px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chat-container { flex: 1; overflow-y: auto; padding: 2rem; scroll-behavior: smooth; }
        .msg-user { background: #3b82f6; align-self: flex-end; border-radius: 18px 18px 2px 18px; padding: 12px 16px; max-width: 85%; }
        .msg-ai { background: #334155; align-self: flex-start; border-radius: 18px 18px 18px 2px; padding: 12px 16px; max-width: 85%; }
        .settings-panel { background: #0f172a; border-top: 1px solid #334155; padding: 1.5rem; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="authOverlay" class="fixed inset-0 bg-[#0f172a] z-[100] flex items-center justify-center p-4">
        <div class="bg-[#1e293b] p-8 rounded-3xl w-full max-w-md border border-slate-700 shadow-2xl">
            <h1 class="text-3xl font-bold text-center mb-6">PeroAI v10.2</h1>
            
            <div id="userAuth">
                <button onclick="signInGoogle()" class="w-full bg-white text-black font-bold py-3 rounded-xl flex items-center justify-center gap-3 mb-4 hover:bg-slate-200 transition">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="20"> Login with Google
                </button>
                <p class="text-center text-xs text-slate-500 underline cursor-pointer" onclick="toggleAuth('login')">Admin Portal Access</p>
            </div>

            <div id="adminAuth" class="hidden space-y-4">
                <h2 class="text-xl font-bold text-center text-red-400">Admin Secure Login</h2>
                <input type="email" id="admEmail" placeholder="Admin Email" class="w-full bg-[#0f172a] border border-slate-700 p-3 rounded-xl outline-none text-white">
                <input type="password" id="admPass" placeholder="Password" class="w-full bg-[#0f172a] border border-slate-700 p-3 rounded-xl outline-none text-white">
                <button onclick="adminLogin()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-500 transition">Login to System</button>
                <p onclick="toggleAuth('main')" class="text-center text-xs text-slate-500 cursor-pointer">Back</p>
            </div>
            <p id="authError" class="text-red-400 text-center text-[11px] mt-4 font-mono"></p>
        </div>
    </div>

    <nav class="sidebar">
        <div class="p-6">
            <button onclick="newChat()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> New Chat
            </button>
        </div>
        <div id="historyList" class="flex-1 overflow-y-auto px-4 space-y-2"></div>

        <div class="settings-panel space-y-4">
            <h3 class="text-xs font-bold text-slate-500 uppercase">Settings</h3>
            <input type="password" id="apiKey" class="w-full bg-[#1e293b] border border-slate-700 text-xs p-2 rounded-lg" placeholder="OpenRouter API Key" onchange="saveConfig()">
            <input type="text" id="modelId" class="w-full bg-[#1e293b] border border-slate-700 text-xs p-2 rounded-lg" value="google/gemini-2.0-flash-exp:free" onchange="saveConfig()">
            
            <div id="adminLink" class="hidden">
                <button onclick="openAdmin()" class="w-full bg-red-900/40 text-red-400 text-xs font-bold py-2 rounded-lg border border-red-800">
                    <i class="fas fa-shield-alt mr-2"></i> Admin Panel
                </button>
            </div>
            <button onclick="logout()" class="w-full text-slate-500 text-xs hover:text-white py-2">Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <header class="h-16 border-b border-slate-800 px-8 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="uAvatar" class="w-8 h-8 rounded-full bg-slate-700 overflow-hidden border border-slate-600 flex items-center justify-center font-bold">P</div>
                <div>
                    <h2 id="uName" class="text-sm font-bold">Guest</h2>
                    <span id="uRole" class="text-[10px] text-blue-400 uppercase font-bold">Standard User</span>
                </div>
            </div>
            <div id="statusInfo" class="text-[10px] font-mono text-slate-500">SYSTEM IDLE</div>
        </header>

        <div id="chatBox" class="chat-container flex flex-col gap-6 pb-32"></div>

        <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#0f172a] to-transparent">
            <div class="max-w-4xl mx-auto flex gap-3 bg-[#1e293b] p-2 rounded-2xl border border-slate-700 shadow-2xl">
                <textarea id="msgInput" rows="1" class="flex-1 bg-transparent p-3 outline-none text-sm resize-none" placeholder="Ask anything..."></textarea>
                <button onclick="handleSend()" class="bg-blue-600 w-12 h-12 rounded-xl hover:bg-blue-500 transition flex items-center justify-center">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>

    <div id="adminModal" class="fixed inset-0 bg-black/90 z-[110] hidden flex items-center justify-center p-6">
        <div class="bg-[#1e293b] w-full max-w-3xl rounded-3xl border border-red-900/30 flex flex-col h-[85vh]">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <h2 class="text-xl font-bold text-red-400">Admin Control</h2>
                <button onclick="document.getElementById('adminModal').classList.add('hidden')" class="text-slate-500 hover:text-white text-xl">&times;</button>
            </div>
            
            <div class="p-6 bg-[#0f172a] border-b border-slate-800">
                <h3 class="text-xs font-bold text-blue-400 uppercase mb-4">Register Sub-Admin Account</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="email" id="newAdminEmail" placeholder="Email Address" class="bg-[#1e293b] p-3 rounded-xl text-xs border border-slate-700 outline-none">
                    <input type="password" id="newAdminPass" placeholder="Password" class="bg-[#1e293b] p-3 rounded-xl text-xs border border-slate-700 outline-none">
                </div>
                <button onclick="registerNewAdmin()" class="w-full bg-blue-600 py-3 rounded-xl text-xs font-bold">Create Official Admin Account</button>
                <div id="adminRegStatus" class="mt-4 p-3 rounded-lg bg-black/20 font-mono text-[10px] text-slate-400 hidden"></div>
            </div>

            <div id="logContent" class="flex-1 overflow-y-auto p-6 font-mono text-[10px] space-y-1"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBqG8rYJZ4xVwR5TrOnzdmlD-eqH8J7TTU",
            authDomain: "peroai-c9000.firebaseapp.com",
            projectId: "peroai-c9000",
            storageBucket: "peroai-c9000.firebasestorage.app",
            messagingSenderId: "175925416280",
            appId: "1:175925416280:web:e530c8fde9dbc34191d52d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ðŸ›¡ï¸ DUAL MASTER ADMINS
        const MASTER_ADMINS = ["peroperogamer172@gmail.com", "adityavaibhav579@gmail.com"];

        let user = null;
        let currentChatId = null;

        auth.onAuthStateChanged(async (u) => {
            if (u) {
                user = u;
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('uName').innerText = u.displayName || u.email;
                if(u.photoURL) document.getElementById('uAvatar').innerHTML = `<img src="${u.photoURL}" class="w-full h-full object-cover">`;

                let isAdmin = MASTER_ADMINS.includes(u.email);
                if(!isAdmin) {
                    try {
                        const doc = await db.collection('admins').doc(u.email).get();
                        if(doc.exists) isAdmin = true;
                    } catch(e) {}
                }

                if(isAdmin) {
                    document.getElementById('adminLink').classList.remove('hidden');
                    document.getElementById('uRole').innerText = "System Admin";
                    document.getElementById('uRole').className = "text-[10px] text-red-500 uppercase font-bold";
                }
                loadHistory();
                loadLocalConfig();
            } else {
                document.getElementById('authOverlay').classList.remove('hidden');
            }
        });

        function signInGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        async function adminLogin() {
            const e = document.getElementById('admEmail').value;
            const p = document.getElementById('admPass').value;
            try { await auth.signInWithEmailAndPassword(e, p); }
            catch(err) { document.getElementById('authError').innerText = "DEBUG ERROR: " + err.message; }
        }
        function logout() { auth.signOut(); location.reload(); }
        function toggleAuth(mode) {
            document.getElementById('userAuth').classList.toggle('hidden', mode === 'login');
            document.getElementById('adminAuth').classList.toggle('hidden', mode !== 'login');
        }

        async function registerNewAdmin() {
            const email = document.getElementById('newAdminEmail').value.trim();
            const pass = document.getElementById('newAdminPass').value;
            const statusBox = document.getElementById('adminRegStatus');
            statusBox.classList.remove('hidden');
            statusBox.innerText = "Initializing registration sequence...";

            try {
                // Step 1: Add to whitelist
                await db.collection('admins').doc(email).set({ addedBy: user.email, time: Date.now() });
                
                // Step 2: REST API Call with full debugging
                const res = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password: pass, returnSecureToken: false })
                });
                
                const data = await res.json();
                if(data.error) {
                    statusBox.innerHTML = `<span class="text-red-400">FAILED: ${data.error.message}</span><br>Check if Identity Toolkit API is enabled in Google Cloud Console.`;
                } else {
                    statusBox.innerHTML = `<span class="text-green-400">SUCCESS: Account created for ${email}.</span>`;
                    logEvent('admin_reg', `New Admin Created: ${email}`);
                }
            } catch (err) {
                statusBox.innerHTML = `<span class="text-red-400">CRITICAL ERROR: ${err.message}</span>`;
            }
        }

        // --- Standard Chat Logic ---
        function saveConfig() {
            localStorage.setItem('p_key', document.getElementById('apiKey').value);
            localStorage.setItem('p_model', document.getElementById('modelId').value);
        }
        function loadLocalConfig() {
            document.getElementById('apiKey').value = localStorage.getItem('p_key') || "";
            document.getElementById('modelId').value = localStorage.getItem('p_model') || "google/gemini-2.0-flash-exp:free";
        }
        function newChat() { currentChatId = null; document.getElementById('chatBox').innerHTML = '<p class="text-center opacity-20 mt-20">New Project Started</p>'; }

        async function handleSend() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            const key = document.getElementById('apiKey').value;
            if(!text || !key) return;
            if(!currentChatId) currentChatId = Date.now().toString();
            appendMessage('user', text);
            input.value = '';
            document.getElementById('statusInfo').innerText = "THINKING...";

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: document.getElementById('modelId').value, messages: [{role:"user", content: text}] })
                });
                const data = await res.json();
                const aiMsg = data.choices[0].message.content;
                appendMessage('ai', aiMsg);
                saveChat(text, aiMsg);
                document.getElementById('statusInfo').innerText = "READY";
            } catch(e) { document.getElementById('statusInfo').innerText = "ERROR"; }
        }

        function appendMessage(role, text) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = role === 'user' ? 'msg-user' : 'msg-ai';
            
            // Java Downloader Feature
            let content = text;
            if(role === 'ai') {
                content = text.replace(/```java([\s\S]*?)```/g, (m, code) => {
                    return `<div class="bg-black/40 p-3 rounded-lg my-2 border border-slate-600 font-mono text-[11px]">
                        <div class="flex justify-between mb-2"><span>Java Code</span><button onclick="downloadCode(\`${encodeURIComponent(code.trim())}\`)" class="bg-blue-600 px-2 py-0.5 rounded text-[10px]">Download .java</button></div>
                        <pre>${code.trim()}</pre>
                    </div>`;
                });
            }
            div.innerHTML = content;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function downloadCode(code) {
            const blob = new Blob([decodeURIComponent(code)], {type:'text/java'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'PeroAI_Plugin.java';
            a.click();
        }

        async function saveChat(u, a) {
            const ref = db.collection('users').doc(user.uid).collection('chats').doc(currentChatId);
            const snap = await ref.get();
            if(snap.exists) await ref.update({ msgs: firebase.firestore.FieldValue.arrayUnion({u, a}) });
            else { await ref.set({ id: currentChatId, title: u.slice(0, 20), timestamp: Date.now(), msgs: [{u, a}] }); loadHistory(); }
        }

        async function loadHistory() {
            const snap = await db.collection('users').doc(user.uid).collection('chats').orderBy('timestamp', 'desc').get();
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            snap.forEach(doc => {
                const chat = doc.data();
                const div = document.createElement('div');
                div.className = "p-2 hover:bg-slate-700 rounded-lg cursor-pointer text-xs flex justify-between group";
                div.innerHTML = `<span onclick="loadChat('${chat.id}')" class="truncate flex-1">${chat.title}</span><i class="fas fa-trash opacity-0 group-hover:opacity-100 hover:text-red-400" onclick="deleteChat('${chat.id}')"></i>`;
                list.appendChild(div);
            });
        }

        async function loadChat(id) {
            currentChatId = id;
            const doc = await db.collection('users').doc(user.uid).collection('chats').doc(id).get();
            document.getElementById('chatBox').innerHTML = '';
            doc.data().msgs.forEach(m => { appendMessage('user', m.u); appendMessage('ai', m.a); });
        }

        async function deleteChat(id) { if(confirm('Delete?')) { await db.collection('users').doc(user.uid).collection('chats').doc(id).delete(); loadHistory(); } }
        async function logEvent(t, m) { await db.collection('system_logs').add({ t, m, u: user.email, time: Date.now() }); }
        async function openAdmin() {
            document.getElementById('adminModal').classList.remove('hidden');
            const snap = await db.collection('system_logs').orderBy('time', 'desc').limit(20).get();
            const cont = document.getElementById('logContent');
            cont.innerHTML = '';
            snap.forEach(d => { const l = d.data(); cont.innerHTML += `<div><span class="text-slate-600">[${new Date(l.time).toLocaleTimeString()}]</span> <span class="text-blue-400">${l.t}:</span> ${l.m}</div>`; });
        }
    </script>
</body>
    </html>
