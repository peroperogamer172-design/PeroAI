async function sendMessage() {
    const text = userInput.value.trim();
    if (!text || !state.apiKey) return;

    if (!state.currentChatId) state.currentChatId = Date.now();

    appendMessage('user', text);
    userInput.value = '';
    userInput.style.height = 'auto';

    const loadingDiv = document.createElement('div');
    loadingDiv.className = "flex justify-start animate-pulse";
    loadingDiv.innerHTML = `<div class="bg-[#313244] p-4 rounded-2xl text-slate-400 text-sm">AI is thinking...</div>`;
    chatContainer.appendChild(loadingDiv);

    try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${state.apiKey}`,
                "Content-Type": "application/json",
                // OpenRouter specific headers (highly recommended)
                "HTTP-Referer": window.location.href, 
                "X-Title": "Universal AI Chat"
            },
            body: JSON.stringify({
                "model": state.model,
                "messages": [{ "role": "user", "content": text }]
            })
        });

        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error.message || "API Error");
        }

        chatContainer.removeChild(loadingDiv);
        const aiResponse = data.choices[0].message.content;
        appendMessage('assistant', aiResponse);
        saveToHistory(text, aiResponse);

    } catch (error) {
        if (loadingDiv.parentNode) chatContainer.removeChild(loadingDiv);
        appendMessage('assistant', `⚠️ Error: ${error.message}`);
        console.error("Detailed Error:", error);
    }
}
